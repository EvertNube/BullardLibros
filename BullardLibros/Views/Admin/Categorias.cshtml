@using BullardLibros.Core.DTO
@{
    ViewBag.Title = "NubeLabs SCI - Categorias";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}
@model IList<BullardLibros.Core.DTO.CategoriaDTO>

@section styles{
    @Styles.Render("~/Content/themes/admin/js/nestable/nestable.css")

    <style type="text/css">
        .dd3-item > button {
            margin-left: 0px;
        }
    </style>
}
@section scripts{
    @Scripts.Render("~/Content/themes/admin/js/nestable/jquery.nestable.js")
    @Scripts.Render("~/Content/themes/admin/js/nestable/demo.js")

    <script type="text/javascript">
        $(function () {
            $('#grupoPeriodos li a').on('click', function (event) {
                console.log($(this).text());
                var pPeriodo = $(this).attr('id');
                console.log(pPeriodo);
                actualizarPeriodo(pPeriodo);
                //alert($(this).children());
            });
        });

        var defaultText = '0';

        function endEdit(e) {
            var input = $(e.target),
                label = input && input.prev();

            label.text(input.val() === '' ? defaultText : input.val());
            input.hide();
            label.show();
        }

        $('.clickedit').hide()
        .focusout(endEdit)
        .keyup(function (e) {
            if ((e.which && e.which == 13) || (e.keyCode && e.keyCode == 13)) {
                endEdit(e);
                //console.log("Hola1");
                console.log($(this).val());


                return false;
            } else {
                //console.log("Hola3");
                console.log($(this).val());
                return true;
            }
        })
        .prev().click(function () {
            $(this).hide();
            $(this).next().show().focus();
            console.log("Hola2");
        });

        function actualizarPeriodo(idPeriodo) {
            $.ajax({
                type: "POST",
                url: "/Admin/ActualizarPeriodo",
                cache: false,
                data: { idPeriodo: idPeriodo },
                dataType: 'text',
                success: function (response) {
                    if(response == "true")
                    {window.location.href = "@Url.Action("Categorias","Admin")";}
                    else
                    { alert("Error al actualizar el periodo");}
                }
            });
        }

    </script>
}
@functions{
    public string printTree(IList<BullardLibros.Core.DTO.CategoriaDTO> categorias, int nivel)
    {
        if (categorias != null && categorias.Count != 0)
        {
            System.Text.StringBuilder output = new System.Text.StringBuilder("<ol class='dd-list'>");

            foreach (BullardLibros.Core.DTO.CategoriaDTO obj in categorias)
            {
                var classInactive = (ViewBag.EsAdmin && !obj.Estado) ? " inactive" : "";
                var styleI = (ViewBag.EsAdmin && !obj.Estado) ? "style='display:none;'" : "";
                output.AppendFormat("<li class='dd-item dd3-item" + classInactive + "' data-id='{0}' " + styleI + "><div class='dd3-content row' style='{1}'><div class='col-md-6'>{2}<b class='badge bg-warning dot {3}'></b></div>", obj.IdCategoria, nivel == 3 || obj.Hijos.Count == 0 ? "color: #428BCA;" : "", obj.Nombre, obj.Estado ? "green" : "red");
                output.Append("<div class='col-md-3 text-right'>");
                if (obj.Hijos == null || obj.Hijos.Count == 0) output.Append("<label class='pull-left'>Sin valor</label><input class='form-control input-sm clickedit' type='text' />");
                else output.AppendFormat("<label class='pull-left'>{0}</label>", "Monto Padre");
                output.Append("</div>");
                output.Append("<div class='col-md-3 text-right'><div class='btn-group'>");
                if (obj.IdCategoriaPadre != null || ViewBag.EsAdmin) { output.AppendFormat("<a class='btn-add' href='{0}'><i class='fa fa-pencil'></i></a>", Url.Action("Categoria", new { id = obj.IdCategoria })); }
                if (nivel < 3) { output.AppendFormat("<a class='btn-add' href='{0}' title='Nueva Categoría Interna'><i class='fa fa-plus'></i></a>", Url.Action("Categoria", new { id = 0, idPadre = obj.IdCategoria })); }
                output.Append("</div></div></div>");
                if (obj.Hijos != null && obj.Hijos.Count != 0) { output.Append(printTree(obj.Hijos, nivel + 1)); }
                output.Append("</li>");
            }

            output.Append("</ol>");
            return output.ToString();
        }
        else return "";
    }
}

<section class="vbox">
    <section class="scrollable padder">
        <div class="row m-b">
            <div class="col-xs-12 col-md-10 col-md-offset-1">
                <h2>Partidas de Presupuesto</h2>
                @Html.Partial("_showAlertMessages")
                <section class="panel panel-default">
                    @if (ViewBag.EsAdmin)
                    {
                        <div class="panel-header text-sm wrapper">
                            <div class="col-sm-4">
                                <div class="btn-group">
                                    <label><input type="checkbox" id="btn-showInactive" /> Mostrar Inactivos</label>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="leyend" style="transform:translateY(48%);">
                                    <p>Leyenda:&nbsp;<b class='badge bg-warning dot'></b> Activo&nbsp;<b class='badge bg-warning dot red'></b> Inactivo</p>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <a class="btn btn-sm btn-success pull-right" href="@Url.Action("Categoria")"><i class="fa fa-plus"></i> Crear nuevo</a>
                            </div>
                        </div>
                    }
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-6 text-left">
                                <button id="nestable-menu" class="btn btn-xs btn-default active" data-toggle="class:show" style="margin-left:30px;">
                                    <i class="fa fa-plus text"></i> <span class="text">Expandir</span>
                                    <i class="fa fa-minus text-active"></i> <span class="text-active">Colapsar</span>
                                </button>
                            </div>
                            <div class="col-md-6">
                                <div class="btn-group pull-right m-r">
                                    @{string vOption = "Periodos";}
                                    <button id="@("btnPeriodo" + ViewBag.IdPeriodo)" data-toggle="dropdown" class="btn btn-info btn-sm dropdown-toggle">
                                        @foreach (var item in (List<PeriodoDTO>)ViewBag.Periodos)
                                        {
                                            if (item.IdPeriodo == ViewBag.IdPeriodo)
                                            {
                                                vOption = item.Nombre;
                                            }
                                        }
                                        @vOption &nbsp;
                                        <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu" id="grupoPeriodos">
                                        @{string pCadena = "";}
                                        @foreach (var item in (List<PeriodoDTO>)ViewBag.Periodos)
                                        {
                                            pCadena = item.IdPeriodo == ViewBag.IdPeriodo ? "active" : "";
                                            <li class="@pCadena"><a href="#" id="@item.IdPeriodo" >@item.Nombre</a></li>
                                        }
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="dd" id="nestable3">
                                @Html.Raw(printTree(Model, 1))
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </section>
</section>